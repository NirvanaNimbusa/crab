<%!
    import pytz

    from crab.util.string import mergelines

    scripts = ["editnotify"]
%>
<%inherit file="base.html"/>

<%block name="links">
<a href="/host/${info['host'] | h}">${info['host'] | h}</a>
<a href="/user/${info['user'] | h}">${info['user'] | h}</a>
% if info['jobid'] is not None:
<a href="/job/${id | h}">${info['jobid'] | h}</a>
% else:
<a href="/job/${id | h}">${info['command'] | h}</a>
% endif
<span>notifications</span>
</%block>

<%def name="notifyrow(n)" filter="mergelines">
<%
          nid = n['notifyid']
%>
<tr id="row_${nid | h}">
    <td><select name="method_${nid | h}">
% for (method, methodname) in [('email', 'Email')]:
        <option value="${method}"
% if method == n.get('method'):
            selected="selected"
% endif
        >${methodname}</option>
% endfor
    </select></td>
    <td><input id="address_${nid | h}" name="address_${nid | h}"
% if n.get('address') is not None:
            value="${n['address'] | h}"
% else:
            value=""
% endif
        /></td>
    <td><input name="time_${nid | h}"
% if n.get('time') is not None:
            value="${n['time'] | h}"
% else:
            value=""
% endif
        /></td>
    <td><select name="timezone_${nid | h}">
        <option value=""
% if n.get('timezone') is None:
            selected="selected"
% endif
        >Unspecified</option>
% for tz in pytz.common_timezones:
        <option value="${tz | h}"
% if tz == n.get('timezone'):
            selected="selected"
% endif
        >${tz | h}</option>
% endfor
    </select></td>
    <td><input name="include_ok_${nid | h}" type="checkbox"
% if not n.get('skip_ok'):
        checked="checked"
% endif
    /></td>
    <td><input name="include_warning_${nid | h}" type="checkbox"
% if not n.get('skip_warning'):
        checked="checked"
% endif
    /></td>
    <td><input name="include_error_${nid | h}" type="checkbox"
% if not n.get('skip_error'):
        checked="checked"
% endif
    /></td>
    <td><input name="include_output_${nid | h}" type="checkbox"
% if n.get('include_output'):
        checked="checked"
% endif
    /></td>
    <td class="linkcell">
        <a href="#" id="delete_${nid | h}">Delete</a>
    </td>
</tr>
</%def>

<h2>Configure Job Notifications</h2>

<form method="post" action="/job/${id | h}/notify">
<table id="notifylist">
<tr>
    <th>Method</th>
    <th>Address</th>
    <th>Schedule</th>
    <th>Timezone</th>
    <th>Successes</th>
    <th>Warnings</th>
    <th>Errors</th>
    <th>Output</th>
    <th>Actions</th>
</tr>
% if notifications is not None:
%     for n in notifications:
          ${notifyrow(n)}
%     endfor
% endif
</table>
<p>
<a href="#" id="add_notification">Add notification.</a>
</p>
<p>
<input type="submit" name="submit_notify" value="Configure" />
</p>
</form>

<script>
<% n = {'notifyid': 'XXX'} %>
var notifyrowtemplate = '${notifyrow(n)}';
</script>
