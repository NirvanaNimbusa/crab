#!/usr/bin/env python2

import sqlite3

import cherrypy

from crab.db import CrabDB
from crab.monitor import CrabMonitor
from crab.server import CrabServer
from crab.web import CrabWeb

def main():
    dbconn = sqlite3.connect("crab.db", check_same_thread = False)
    c = dbconn.cursor()
    c.execute("PRAGMA foreign_keys = ON");
    c.close()

    store = CrabDB(dbconn)
    monitor = CrabMonitor(store)
    monitor.daemon = True
    monitor.start()

    cherrypy.config.update({"server.socket_port": 8000})
    cherrypy.tree.mount(CrabWeb(store), "/", {})
    cherrypy.tree.mount(CrabServer(store), "/api/0", {})

    # From the CherryPy documentation:
    if hasattr(cherrypy.engine, 'block'):
        # 3.1 syntax
        cherrypy.engine.start()
        cherrypy.engine.block()
    else:
        # 3.0 syntax
        cherrypy.server.quickstart()
        cherrypy.engine.start()

if __name__ == "__main__":
    main()
