#!/usr/bin/env python2

from BaseHTTPServer import HTTPServer, BaseHTTPRequestHandler
import sqlite3

from crab.server import CrabServer
from crab.www import CrabWWW
from crab.db import CrabDB

class CrabHandler(CrabServer, CrabWWW):

    # Static variable which must be set to the storage backend
    # to be used.  It's called 'store' so that it could take a
    # type using a storage mechanism other than a database.
    store = None

    def is_crab(self):
        return self.path.startswith('/api/')

    def do_GET(self):
        if self.is_crab():
            CrabServer.do_GET(self)
        else:
            CrabWWW.do_GET(self)

    def do_POST(self):
        if self.is_crab():
            CrabServer.do_POST(self)
        else:
            CrabWWW.do_POST(self)

    def do_PUT(self):
        if self.is_crab():
            CrabServer.do_PUT(self)
        else:
            CrabWWW.do_PUT(self)


def main():
    dbconn = sqlite3.connect("crab.db")
    c = dbconn.cursor()
    c.execute("PRAGMA foreign_keys = ON");
    c.close()

    CrabHandler.store = CrabDB(dbconn)

    httpd = HTTPServer(("", 8000), CrabHandler)
    httpd.serve_forever()

if __name__ == "__main__":
    main()
